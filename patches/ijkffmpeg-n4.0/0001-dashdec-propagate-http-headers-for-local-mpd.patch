From ff9cdd4c8a0fab0bc0d30cdcdb7dab3ee7e5fc4a Mon Sep 17 00:00:00 2001
From: FFToolChain <fftoolchain@localhost>
Date: Thu, 26 Feb 2026 10:42:04 +0000
Subject: [PATCH] dashdec: keep HTTP headers for local MPD

---
 libavformat/dashdec.c | 26 ++++++++++++++++++++++----
 1 file changed, 22 insertions(+), 4 deletions(-)

diff --git a/libavformat/dashdec.c b/libavformat/dashdec.c
index 8bfde4d..2b33881 100644
--- a/libavformat/dashdec.c
+++ b/libavformat/dashdec.c
@@ -375,6 +375,8 @@ static void free_audio_list(DASHContext *c)
 static void set_httpheader_options(DASHContext *c, AVDictionary **opts)
 {
     // broker prior HTTP options that should be consistent across requests
+    // http.c supports "user_agent" and (deprecated) "user-agent".
+    av_dict_set(opts, "user_agent", c->user_agent, 0);
     av_dict_set(opts, "user-agent", c->user_agent, 0);
     av_dict_set(opts, "cookies", c->cookies, 0);
     av_dict_set(opts, "headers", c->headers, 0);
@@ -386,7 +388,7 @@ static void update_options(char **dest, const char *name, void *src)
 {
     av_freep(dest);
     av_opt_get(src, name, AV_OPT_SEARCH_CHILDREN, (uint8_t**)dest);
-    if (*dest)
+    if (*dest && !strlen(*dest))
         av_freep(dest);
 }
 
@@ -1873,9 +1875,16 @@ static int dash_read_header(AVFormatContext *s)
     c->interrupt_callback = &s->interrupt_callback;
     // if the URL context is good, read important options we must broker later
     if (u) {
-        update_options(&c->user_agent, "user-agent", u);
-        update_options(&c->cookies, "cookies", u);
-        update_options(&c->headers, "headers", u);
+        // Keep app-provided values (set via AVOptions) when MPD is local.
+        if (!c->user_agent) {
+            update_options(&c->user_agent, "user_agent", u);
+            if (!c->user_agent)
+                update_options(&c->user_agent, "user-agent", u);
+        }
+        if (!c->cookies)
+            update_options(&c->cookies, "cookies", u);
+        if (!c->headers)
+            update_options(&c->headers, "headers", u);
     }
 
     if ((ret = parse_manifest(s, s->filename, s->pb)) < 0)
@@ -2035,6 +2044,7 @@ static int dash_close(AVFormatContext *s)
 
     av_freep(&c->cookies);
     av_freep(&c->user_agent);
+    av_freep(&c->headers);
     av_dict_free(&c->avio_opts);
     av_freep(&c->base_url);
     return 0;
@@ -2150,6 +2160,14 @@ static int dash_probe(AVProbeData *p)
 #define OFFSET(x) offsetof(DASHContext, x)
 #define FLAGS AV_OPT_FLAG_DECODING_PARAM
 static const AVOption dash_options[] = {
+    {"headers", "set custom HTTP headers (applies to DASH sub-requests too)",
+        OFFSET(headers), AV_OPT_TYPE_STRING, { .str = NULL }, 0, 0, FLAGS},
+    {"user_agent", "override User-Agent header (applies to DASH sub-requests too)",
+        OFFSET(user_agent), AV_OPT_TYPE_STRING, { .str = NULL }, 0, 0, FLAGS},
+    {"user-agent", "override User-Agent header (alias for user_agent)",
+        OFFSET(user_agent), AV_OPT_TYPE_STRING, { .str = NULL }, 0, 0, FLAGS},
+    {"cookies", "set cookies (applies to DASH sub-requests too)",
+        OFFSET(cookies), AV_OPT_TYPE_STRING, { .str = NULL }, 0, 0, FLAGS},
     {"allowed_extensions", "List of file extensions that dash is allowed to access",
         OFFSET(allowed_extensions), AV_OPT_TYPE_STRING,
         {.str = "aac,m4a,m4s,m4v,mov,mp4"},
-- 
2.34.1
